<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financiero</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { createClient } = supabase;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LineChart, Line, Legend } = Recharts;

        // CREDENCIALES
        const supabaseUrl = 'http://127.0.0.1:54321';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0';
        const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

        // Mapeo
        const CONCEPT_MAPPING = {
            "EROGACIONES POR REMUNERACIONES AL TRABAJO PERSONAL": "Remuneraciones",
            "IMPUESTO SOBRE LA PRESTACIÓN DE SERVICIOS DE HOSPEDAJE": "Hospedaje"
        };

        // Utilidades
        const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 0 }).format(val || 0);
        const formatCompactNumber = (num) => new Intl.NumberFormat('es-MX', { notation: "compact", compactDisplay: "short", style: 'currency', currency: 'MXN' }).format(num);
        const getMonthName = (m) => {
            if (!m) return "";
            const date = new Date(2000, m - 1, 1);
            const name = date.toLocaleString('es-MX', { month: 'long' });
            return name.charAt(0).toUpperCase() + name.slice(1);
        };

        // Componentes
        const KPICard = ({ title, amount, percentage, subtext }) => (
            <div className="bg-white border border-slate-200 rounded-xl p-6 shadow-sm">
                <div className="flex justify-between items-start mb-4">
                    <div className="p-2 bg-slate-50 rounded-lg border border-slate-100 text-slate-700 font-bold">
                       $ </div>
                    {percentage && percentage !== "0" && (
                        <span className="text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full border border-emerald-100">
                            {percentage}%
                        </span>
                    )}
                </div>
                <div>
                    <h3 className="text-slate-500 text-xs font-semibold uppercase tracking-wider mb-1">{title}</h3>
                    <div className="text-2xl font-bold text-slate-900 tracking-tight">{amount}</div>
                    {subtext && <p className="text-xs text-slate-400 mt-2">{subtext}</p>}
                </div>
            </div>
        );

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-slate-900 text-white p-3 rounded-lg shadow-xl border border-slate-700 text-xs z-50">
                        <p className="font-semibold mb-2 border-b border-slate-700 pb-1">{label}</p>
                        {payload.map((entry, index) => (
                            <div key={index} className="flex items-center justify-between gap-4 mb-1">
                                <span style={{ color: entry.color }}>{entry.name}:</span>
                                <span className="font-mono">{formatCurrency(entry.value)}</span>
                            </div>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // App Principal
        function App() {
            const [filterYear, setFilterYear] = useState('ALL');
            const [dbData, setDbData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        setLoading(true);
                        const { data, error } = await supabaseClient
                            .from('ingresos_v1')
                            .select('ejercicio_fiscal, mes, concepto, total_recaudado');

                        if (error) throw error;

                        const transformedData = data.map(item => ({
                            year: Number(item.ejercicio_fiscal),
                            month: Number(item.mes),
                            concept: item.concepto,
                            amount: Number(item.total_recaudado)
                        }));
                        setDbData(transformedData);
                    } catch (err) {
                        console.error(err);
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchData();

                const channel = supabaseClient
                    .channel('realtime_ingresos')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'ingresos_v1' }, () => fetchData())
                    .subscribe();

                return () => { supabaseClient.removeChannel(channel); };
            }, []);

            const processedData = useMemo(() => {
                if (loading || error) return [];
                let data = dbData.map((item, index) => ({
                    ...item,
                    id: index,
                    shortConcept: CONCEPT_MAPPING[item.concept] || item.concept,
                    dateLabel: `${getMonthName(item.month)} ${item.year}`
                }));
                return data.sort((a, b) => (a.year !== b.year) ? b.year - a.year : b.month - a.month);
            }, [dbData, loading, error]);

            const tableData = useMemo(() => {
                if (filterYear === 'ALL') return processedData;
                return processedData.filter(d => d.year.toString() === filterYear);
            }, [processedData, filterYear]);

            const kpis = useMemo(() => {
                const sourceData = tableData;
                const totalRevenue = sourceData.reduce((acc, curr) => acc + (curr.amount || 0), 0);
                const remuneraciones = sourceData.filter(d => d.concept && d.concept.includes("REMUNERACIONES")).reduce((acc, curr) => acc + (curr.amount || 0), 0);
                const hospedaje = sourceData.filter(d => d.concept && d.concept.includes("HOSPEDAJE")).reduce((acc, curr) => acc + (curr.amount || 0), 0);

                return {
                    total: totalRevenue,
                    remuneraciones: { amount: remuneraciones, percent: totalRevenue ? ((remuneraciones / totalRevenue) * 100).toFixed(1) : 0 },
                    hospedaje: { amount: hospedaje, percent: totalRevenue ? ((hospedaje / totalRevenue) * 100).toFixed(1) : 0 }
                };
            }, [tableData]);

            const stackedBarData = useMemo(() => {
                const grouped = {};
                processedData.forEach(item => {
                    if (!grouped[item.year]) grouped[item.year] = { year: item.year, Remuneraciones: 0, Hospedaje: 0 };
                    if (item.concept.includes("REMUNERACIONES")) grouped[item.year].Remuneraciones += item.amount;
                    else grouped[item.year].Hospedaje += item.amount;
                });
                return Object.values(grouped).sort((a, b) => a.year - b.year);
            }, [processedData]);

            const trendLineData = useMemo(() => {
                const monthMap = {};
                for(let i=1; i<=12; i++) {
                    const mName = getMonthName(i);
                    monthMap[i] = { month: i, name: mName.substring(0,3), '2023': 0, '2024': 0, '2025': 0 };
                }
                processedData.forEach(item => {
                    if (monthMap[item.month]) {
                        const yearKey = item.year.toString();
                        if (monthMap[item.month][yearKey] === undefined) monthMap[item.month][yearKey] = 0;
                        monthMap[item.month][yearKey] += item.amount;
                    }
                });
                return Object.values(monthMap);
            }, [processedData]);

            if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="loader"></div></div>;

            return (
                <div className="p-8 max-w-7xl mx-auto">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-3xl font-bold text-slate-900">Tablero de Recaudación</h1>
                            <p className="text-slate-500 text-sm mt-1">
                                {error ? <span className="text-red-500">Error: {error}</span> : "Conectado a Supabase Local"}
                            </p>
                        </div>
                        <select className="border rounded p-2" value={filterYear} onChange={(e) => setFilterYear(e.target.value)}>
                            <option value="ALL">Todos los años</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <KPICard title="Recaudación Total" amount={formatCurrency(kpis.total)} subtext={filterYear === 'ALL' ? "Histórico" : `Año ${filterYear}`} />
                        <KPICard title="Remuneraciones" amount={formatCurrency(kpis.remuneraciones.amount)} percentage={kpis.remuneraciones.percent} subtext="Nómina" />
                        <KPICard title="Hospedaje" amount={formatCurrency(kpis.hospedaje.amount)} percentage={kpis.hospedaje.percent} subtext="Hoteleros" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-80">
                            <h3 className="font-semibold mb-4">Comparativa Anual</h3>
                            <ResponsiveContainer width="100%" height="90%">
                                <BarChart data={stackedBarData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="year" />
                                    <YAxis tickFormatter={(val) => new Intl.NumberFormat('es-MX', { notation: "compact" }).format(val)} />
                                    <Tooltip content={<CustomTooltip />} />
                                    <Legend />
                                    <Bar name="Remuneraciones" dataKey="Remuneraciones" stackId="a" fill="#0f172a" radius={[0,0,4,4]} />
                                    <Bar name="Hospedaje" dataKey="Hospedaje" stackId="a" fill="#10b981" radius={[4,4,0,0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm h-80">
                            <h3 className="font-semibold mb-4">Tendencia Mensual</h3>
                            <ResponsiveContainer width="100%" height="90%">
                                <LineChart data={trendLineData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <XAxis dataKey="name" />
                                    <YAxis tickFormatter={(val) => new Intl.NumberFormat('es-MX', { notation: "compact" }).format(val)} />
                                    <Tooltip content={<CustomTooltip />} />
                                    <Legend />
                                    <Line type="monotone" dataKey="2023" stroke="#cbd5e1" dot={false} />
                                    <Line type="monotone" dataKey="2024" stroke="#3b82f6" dot={false} />
                                    <Line type="monotone" dataKey="2025" stroke="#0f172a" strokeWidth={2} />
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
